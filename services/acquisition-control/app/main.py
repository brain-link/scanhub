#!/usr/bin/env python3

# Project: ScanHub
# File: main.py
# Date: June 2023
#
# License:
# Copyright (C) 2023, BRAIN-LINK UG (haftungsbeschr√§nkt). All Rights Reserved.
#
# SPDX-License-Identifier: GPL-3.0-only OR ScanHub commercial license
#
# Licensees holding valid ScanHub commercial licenses may use this file in
# accordance with the ScanHub Commercial License Agreement provided with the
# Software or, alternatively, in accordance with the GPL-3.0-only as published
# by the Free Software Foundation. Please refer to the License for the
# specific language governing the rights and limitations under either license.
#
# Brief: Acquisition control. Receives control cmd from ui and controls scans on devices

#  python -m uvicorn acquisitioncontrol:app --reload
import logging
import json
import requests


from fastapi import FastAPI
from pydantic import BaseModel, Extra, Field  # pylint: disable=no-name-in-module

DEVICE_URI = "host.docker.internal:8001"
SEQUENCE_MANAGER_URI = "host.docker.internal:8003"
EXAM_MANAGER_URI = "host.docker.internal:8004"

# TODO: Move to scanhub-tools
class ScanJob(BaseModel):  # pylint: disable=too-few-public-methods
    """
    Pydantic definition of a scanjob

    Parameters:
    -----------
    job_id : str
        The id of the scanjob (generated by the ui).
    sequence_id : str
        The id of the sequence to run.
    workflow_id : str
        The id of the workflow to run.
    device_id : str
        The id of the device to run the scan on.
    """
    class Config:
        extra = Extra.ignore

    job_id: int = Field(alias="id")
    sequence_id: str
    workflow_id: int
    device_id: int

#TODO: Move to scanhub-tools
class ScanStatus(BaseModel):  # pylint: disable=too-few-public-methods
    """Pydantic definition of a scanjob"""
    record_id: str
    status_percent: int

#TODO: Move to scanhub-tools
class ScanRequest(BaseModel):  # pylint: disable=too-few-public-methods
    """Pydantic definition of data to receive"""
    record_id: str

app = FastAPI(openapi_url="/api/v1/mri/acquisitioncontrol/openapi.json",
              docs_url="/api/v1/mri/acquisitioncontrol/docs")
logging.basicConfig(level=logging.DEBUG)


@app.post("/api/v1/mri/acquisitioncontrol/start-scan")
async def start_scan(scan_job: ScanJob):
    # TODO: Dont ignore device_id, check returns, ... 

    """Receives a job. Create a record id, trigger scan with it and returns it"""
    # get sequence
    res = requests.get(
        f"http://{SEQUENCE_MANAGER_URI}/api/v1/mri/sequences/{scan_job.sequence_id}", timeout=60)
    sequence_json = res.json()

    # create record
    # TODO: data_path, comment ?
    res = requests.post(f"http://{EXAM_MANAGER_URI}/api/v1/exam/record",
                        json={"data_path": "path",
                              "comment": "blub",
                              "job_id": scan_job.job_id}, timeout=60)
    record_id = res.json()["id"]

    # start scan and forward sequence, workflow, record_id
    logging.debug("Received job: %s, Generated record id: %s", scan_job.job_id, record_id)
    print(sequence_json)
    res = requests.post(f"http://{DEVICE_URI}/start-scan",
                        json={"record_id": record_id,
                              "sequence": json.dumps(sequence_json)}, timeout=60)
    print(res)
    return {"record_id": record_id}

@app.post("/api/v1/mri/acquisitioncontrol/forward-status")
async def forward_status(scan_status: ScanStatus):
    """Receives status for a job. Forwards it to the ui and returns ok."""
    return {"message": "Status submitted"}
